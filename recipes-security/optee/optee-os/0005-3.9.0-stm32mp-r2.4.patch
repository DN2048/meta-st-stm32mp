From 7b659ec639556e76a6ae0f498d1227fe76dd96fa Mon Sep 17 00:00:00 2001
From: Lionel VITTE <lionel.vitte@st.com>
Date: Fri, 13 May 2022 10:29:52 +0200
Subject: [PATCH] 3.9.0-stm32mp-r2.4

---
 core/arch/arm/plat-stm32mp1/drivers/stm32mp1_clk.c |  6 ++++--
 core/drivers/gic.c                                 | 12 ++++++++++--
 core/include/drivers/gic.h                         |  3 +++
 3 files changed, 17 insertions(+), 4 deletions(-)

diff --git a/core/arch/arm/plat-stm32mp1/drivers/stm32mp1_clk.c b/core/arch/arm/plat-stm32mp1/drivers/stm32mp1_clk.c
index 4d2769d3..59768ddb 100644
--- a/core/arch/arm/plat-stm32mp1/drivers/stm32mp1_clk.c
+++ b/core/arch/arm/plat-stm32mp1/drivers/stm32mp1_clk.c
@@ -2595,10 +2595,12 @@ static void stm32_clock_resume(void)
 static TEE_Result stm32_clock_pm(enum pm_op op, unsigned int pm_hint __unused,
 				 const struct pm_callback_handle *hdl __unused)
 {
-	if (op == PM_OP_SUSPEND)
+	if (op == PM_OP_SUSPEND) {
 		stm32_clock_suspend();
-	else
+	} else {
+		pll1_config_from_opp_khz(current_opp_khz);
 		stm32_clock_resume();
+	}
 
 	return TEE_SUCCESS;
 }
diff --git a/core/drivers/gic.c b/core/drivers/gic.c
index 3f1a606e..ce82f31f 100644
--- a/core/drivers/gic.c
+++ b/core/drivers/gic.c
@@ -188,9 +188,9 @@ void gic_cpu_init(struct gic_data *gd)
 #endif
 }
 
-void gic_init_setup(struct gic_data *gd)
+void gic_setup_clear_it(struct gic_data *gd)
 {
-	size_t n;
+	size_t n = 0;
 
 	for (n = 0; n <= gd->max_it / NUM_INTS_PER_REG; n++) {
 		/* Disable interrupts */
@@ -198,7 +198,14 @@ void gic_init_setup(struct gic_data *gd)
 
 		/* Make interrupts non-pending */
 		io_write32(gd->gicd_base + GICD_ICPENDR(n), 0xffffffff);
+	};
+}
+
+void gic_init_setup(struct gic_data *gd)
+{
+	size_t n = 0;
 
+	for (n = 0; n <= gd->max_it / NUM_INTS_PER_REG; n++) {
 		/* Mark interrupts non-secure */
 		if (n == 0) {
 			/* per-CPU inerrupts config:
@@ -244,6 +251,7 @@ void gic_init_base_addr(struct gic_data *gd, vaddr_t gicc_base __maybe_unused,
 void gic_init(struct gic_data *gd, vaddr_t gicc_base, vaddr_t gicd_base)
 {
 	gic_init_base_addr(gd, gicc_base, gicd_base);
+	gic_setup_clear_it(gd);
 	gic_init_setup(gd);
 }
 
diff --git a/core/include/drivers/gic.h b/core/include/drivers/gic.h
index c8da6d84..078de9c2 100644
--- a/core/include/drivers/gic.h
+++ b/core/include/drivers/gic.h
@@ -43,6 +43,9 @@ struct gic_data {
 #endif
 };
 
+/* Disable interrupts and make them non-pending */
+void gic_setup_clear_it(struct gic_data *gd);
+
 /*
  * The two gic_init_* functions initializes the struct gic_data which is
  * then used by the other functions.
-- 
2.17.1

